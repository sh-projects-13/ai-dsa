name: CI - Main Branch Check

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    name: ğŸ› ï¸ Build & Validate
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Needed for full commit history

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests
        run: npm test

      - name: ğŸ§± TypeScript check
        run: npx tsc --noEmit

      - name: ğŸ’… Lint code
        run: npx eslint . --ext .ts,.tsx

      - name: ğŸ” Check for merge conflicts
        run: |
          if git diff --check | grep '<<<<<<<'; then
            echo "âŒ Merge conflicts found!"
            exit 1
          fi

      - name: ğŸ“ Check commit messages (Conventional Commits)
        uses: wagoid/commitlint-github-action@v5
        with:
          configFile: commitlint.config.js

      - name: ğŸ›¡ï¸ Audit for vulnerabilities
        run: npm audit --audit-level=moderate

      - name: ğŸ“ Build (for deploy test)
        run: npm run build

      - name: âœ… Success message
        run: echo "ğŸ‰ All checks passed on main!"
